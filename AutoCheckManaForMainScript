local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local THRESHOLD = 0.05
local LOW_STAMINA_LIMIT = 5  -- S·ªë l·∫ßn c·∫ßn stamina th·∫•p tr∆∞·ªõc khi reset
local STAMINA_CHECK_COOLDOWN = 10  -- Th·ªùi gian gi·ªØa m·ªói l·∫ßn ƒë·∫øm (gi√¢y)

local currentHumanoid = nil
local staminaBar = nil
local canAct = false
local initialDelay = 30
local lowStaminaCount = 0
local lastLowStaminaTime = 0

shared.autoCheckMana = shared.autoCheckMana or false

-- üîÅ H√†m reset nh√¢n v·∫≠t b·∫±ng c√°ch set Health = 0
local function resetCharacter()
    if currentHumanoid then
        currentHumanoid.Health = 0
    end
end

-- üîÅ G√°n l·∫°i nh√¢n v·∫≠t m·ªói khi respawn
local function setupCharacter(character)
    currentHumanoid = character:WaitForChild("Humanoid")
    staminaBar = player:WaitForChild("PlayerGui"):WaitForChild("UI"):WaitForChild("HUD"):WaitForChild("Bars"):WaitForChild("Stamina")
end

-- N·∫øu nh√¢n v·∫≠t ƒë√£ t·ªìn t·∫°i
if player.Character then
    setupCharacter(player.Character)
end

-- Khi nh√¢n v·∫≠t m·ªõi spawn l·∫°i
player.CharacterAdded:Connect(function(char)
    setupCharacter(char)
end)

-- ‚è≥ Delay 30 gi√¢y khi b·∫Øt ƒë·∫ßu
task.wait(initialDelay)
canAct = true

-- üîÑ Theo d√µi Stamina v√† reset khi c·∫ßn
RunService.RenderStepped:Connect(function()
    if shared.autoCheckMana and currentHumanoid and staminaBar and canAct then
        local percent = staminaBar.Size.X.Scale
        local now = tick()

        if percent < THRESHOLD and (now - lastLowStaminaTime >= STAMINA_CHECK_COOLDOWN) then
            lowStaminaCount += 1
            lastLowStaminaTime = now
            print("Stamina th·∫•p l·∫ßn th·ª©: " .. lowStaminaCount)
        elseif percent >= THRESHOLD then
            -- N·∫øu stamina ph·ª•c h·ªìi, c√≥ th·ªÉ cho reset b·ªô ƒë·∫øm n·∫øu mu·ªën.
            -- ·ªû ƒë√¢y ta KH√îNG reset `lowStaminaCount` ƒë·ªÉ gi·ªØ s·ªë l·∫ßn ƒë√£ ƒë·∫øm tr∆∞·ªõc ƒë√≥.
            -- N·∫øu mu·ªën reset khi h·ªìi l·∫°i, b·ªè comment d√≤ng d∆∞·ªõi:
            -- lowStaminaCount = 0
        end

        if lowStaminaCount >= LOW_STAMINA_LIMIT and currentHumanoid.Health > 0 then
            resetCharacter()
            canAct = false
            lowStaminaCount = 0
            lastLowStaminaTime = 0

            task.delay(30, function()
                canAct = true
            end)
        end
    end
end)
