-- üìå K√≠ch ho·∫°t qua bi·∫øn to√†n c·ª•c t·ª´ UI ch√≠nh
shared.autoFarm = shared.autoFarm or false

-- üì¶ D·ªãch v·ª• Roblox
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local RunService = game:GetService("RunService")

-- üßç Ng∆∞·ªùi ch∆°i
local player = Players.LocalPlayer
local gui = player:WaitForChild("PlayerGui")

-- ‚öôÔ∏è Bi·∫øn tr·∫°ng th√°i
local _isInGame = false
local currentFruit = nil
local currentHumanoid = nil
local characterReady = false
local lockedPosition = nil
local lockUntil = 0
local lastTeleportTime = 0

-- üí• Danh s√°ch k·ªπ nƒÉng theo tr√°i √°c qu·ª∑
local skills = {
    ["Flame"] = {"FireBall", "FirePillar", "FlameFlight", "HellRain"},
    ["Ice"] = {"IceSpike", "IceLance", "IceFloor", "Glacier"},
    ["Quake"] = {"QuakeSmash", "QuakePunch", "QuakeStomp", "SeaQuake"},
    ["Magma"] = {"MagmaFist", "MagmaFloor", "VolcanicRain", "MagmaEruption"},
    ["Lightning"] = {"LightningBeam", "LightningStrike", "LightningTeleport", "ThunderGod"},
    ["Darkness"] = {"BlackHole", "DarkVortex", "DarkTeleport", "DarkEnd"},
    ["Light"] = {"LightBeam", "LightKick", "LightFlight", "LightRain"},
    ["Gravity"] = {"GravityPush", "GravityField", "MeteorRain", "PlanetaryDevastation"},
    ["Rubber"] = {"GumPistol", "GumBazooka", "GumGatling", "GumRocket"},
    ["Dragon"] = {"Roar", "Claw", "Flight", "Transformation"},
    ["Phoenix"] = {"BlueFlames", "HealFlames", "PhoenixFlight", "Rebirth"},
    ["Leopard"] = {"LeopardRush", "SavageClaw", "HuntDash", "HybridRampage"},
    ["Smoke"] = {"SmokeBlast", "SmokeBullets", "WhiteOut", "SmokeEscape"},
    ["Bomb"] = {"MiniBomb", "BombThrow", "BombRain", "SelfDestruct"},
    ["Sand"] = {"SandBullet", "SandTornado", "SandTrap", "DesertStorm"},
    ["Paw"] = {"Repel", "AirShock", "Shockwave", "UrsusShock"},
    ["Barrier"] = {"BarrierWall", "BarrierSphere", "Crush", "BarrierPush"},
    ["String"] = {"StringWhip", "StringCage", "Parasite", "Overheat"},
    ["Dough"] = {"DoughFist", "RollerDonut", "StickyNet", "BuzzCut"},
    ["Venom"] = {"VenomSpit", "PoisonMist", "SerpentRush", "Transformation"},
    ["Control"] = {"Shambles", "Room", "Scan", "Takt"},
    ["Soul"] = {"SoulShot", "SoulField", "BigMomScream", "ZeusStrike"},
    ["Shadow"] = {"ShadeKick", "BatStorm", "DarkSwarm", "DarkEmbrace"},
    ["Tremor"] = {"Smash", "WaveBreak", "IslandShake", "OceanQuake"},
}

-- ‚úÖ Ki·ªÉm tra cooldown
local function isSkillReady(skillName)
    local cdFolder = player:FindFirstChild("Cooldowns")
    if not cdFolder then return true end
    local nested = cdFolder:FindFirstChild("Cooldowns")
    if not nested then return true end
    local skillCD = nested:FindFirstChild(skillName)
    return not skillCD or skillCD.Value <= 0
end

-- üß¨ C·∫≠p nh·∫≠t tr√°i hi·ªán t·∫°i
local function updateCurrentFruit()
local mainData = player:FindFirstChild("MAIN_DATA")
    if not mainData then return end
    local currentSlot = mainData:FindFirstChild("Slot")
    if not currentSlot then return end
    local slotValue = mainData.Slots:FindFirstChild(tostring(currentSlot.Value))
    currentFruit = slotValue and slotValue.Value or nil
end

-- üëÄ Theo d√µi thay ƒë·ªïi slot tr√°i
local function watchSlotChanges()
    local mainData = player:WaitForChild("MAIN_DATA", 10)
    if not mainData then return end
    local slot = mainData:WaitForChild("Slot", 5)
    if not slot then return end
    slot:GetPropertyChangedSignal("Value"):Connect(updateCurrentFruit)
    updateCurrentFruit()
end

-- üí• G·ªçi k·ªπ nƒÉng tr√°i
local function castSkill(fruit, skill)
    if not fruit or not skill then return end
    if not isSkillReady(skill) then return end

    local char = player.Character or player.CharacterAdded:Wait()
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    -- Ki·ªÉm tra th·ªùi gian lock
    if tick() < lockUntil then
        hrp.Velocity = Vector3.zero
        hrp.CFrame = CFrame.new(lockedPosition)
    end

    -- Nh·∫Øm ra xa ph√≠a tr∆∞·ªõc thay v√¨ ngay d∆∞·ªõi ch√¢n
    local offset = hrp.CFrame.LookVector * 20
    local target = hrp.Position + offset
    local dir = (target - hrp.Position).Unit * 45
    local ray = {
        Normal = Vector3.yAxis,
        Direction = dir,
        Origin = hrp.Position,
        Instance = workspace.Map:FindFirstChildWhichIsA("BasePart") or workspace.Terrain,
        Distance = (target - hrp.Position).Magnitude,
        Material = Enum.Material.Grass,
        Position = target
    }

    local success, err = pcall(function()
        ReplicatedStorage.Replicator:InvokeServer(fruit, skill, {
            Ground = {Position = target},
            MouseRay = ray
        })
        ReplicatedStorage.ReplicatorNoYield:FireServer("ClientData", "UpdateData", {
            RootCF = hrp.CFrame,
            MouseRay = ray
        })
    end)
    if not success then warn("[castSkill] L·ªói:", err) end
end

-- üîÅ V√≤ng l·∫∑p spam k·ªπ nƒÉng
local skillLoopRunning = false
local function startSkillLoop()
    if skillLoopRunning then return end
    skillLoopRunning = true
    task.spawn(function()
        while true do
            if shared.autoFarm and _isInGame and characterReady and currentFruit and skills[currentFruit] then
                if tick() - lastTeleportTime < 1 then
                    task.wait(0.2)
                else
                    for _, skill in ipairs(skills[currentFruit]) do
                        if not (shared.autoFarm and _isInGame and characterReady) then break end
                        castSkill(currentFruit, skill)
                        task.wait(0.15)
                    end
                end
            else
                task.wait(0.5)
            end
        end
    end)
end

-- üìç D·ªãch chuy·ªÉn v√† kh√≥a v·ªã tr√≠
local function fastTeleport()
    local character = player.Character
    if not character then return end
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local targetPos
    if game.PlaceId == 12413901502 then
        targetPos = Vector3.new(-2229, 534, 1384)
    elseif game.PlaceId == 16190471004 then
        targetPos = Vector3.new(592, 2178, -1481)
    else
        targetPos = Vector3.new(-1420, 798.93, -85)
    end

    hrp.CFrame = CFrame.new(targetPos)
    lockedPosition = targetPos
    lockUntil = tick() + 10
    lastTeleportTime = tick()
end

-- üß† C√†i nh√¢n v·∫≠t
local function setupCharacter(character)
    characterReady = false
    currentHumanoid = character:WaitForChild("Humanoid", 5)
    local hrp = character:WaitForChild("HumanoidRootPart", 5)
    if not hrp or not currentHumanoid then return end

    task.spawn(function()
        local maxWait = 5
        local elapsed = 0
        while elapsed < maxWait do
            updateCurrentFruit()
            if currentFruit and hrp:IsDescendantOf(game) then
                characterReady = true
                break
            end
            elapsed += 0.2
            task.wait(0.2)
        end
    end)
end

-- üëÇ Theo d√µi nh√¢n v·∫≠t m·ªõi
player.CharacterAdded:Connect(function(char)
    _isInGame = true
    characterReady = false
    setupCharacter(char)
    if shared.autoFarm then
        task.delay(5, function()
            fastTeleport()
        end)
    end
end)

-- üöÄ N·∫øu ƒë√£ v√†o game
if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
    _isInGame = true
    setupCharacter(player.Character)
    if shared.autoFarm then
        task.delay(1, fastTeleport)
    end
end

-- üïπÔ∏è T·ª± ƒë·ªông nh·∫•n Play
task.spawn(function()
    while true do
        if shared.autoFarm and not player.Character then
            task.wait(5)
            for _, guiObj in ipairs(gui:GetChildren()) do
                if guiObj:IsA("ScreenGui") then
                    local playButton = guiObj:FindFirstChild("Play", true)
                    if playButton and playButton:IsA("GuiButton") then
                        GuiService.SelectedObject = playButton
                        task.wait(2)
                        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
                        task.wait(0.05)
                        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
                    end
                end
            end
        end
        task.wait(2)
    end
end)

-- üß≤ C·ªë ƒë·ªãnh v·ªã tr√≠ n·∫øu ƒëang b·ªã kh√≥a
RunService.Stepped:Connect(function()
    if tick() < lockUntil and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        local hrp = player.Character.HumanoidRootPart
        hrp.Velocity = Vector3.zero
        hrp.CFrame = CFrame.new(lockedPosition)
    end
end)

watchSlotChanges()
startSkillLoop()
